import { setCookie } from './cookie';
import { cookieName, defaultLocale, excludedRoutes } from './settings';
import { registerMessageLoaders } from './registration';
import { _, init, locale as $locale } from 'svelte-i18n';

let currentLocale = null;

registerMessageLoaders();

const unsubscribe = $locale.subscribe((value) => {
	if (value == null) return;

	currentLocale = value;

	if (typeof window !== 'undefined') {
		setCookie(cookieName, value);
	}
});

const DOCUMENT_REGEX = /^([^.?#@]+)?([?#](.+)?)?$/;

export function i18n() {
    init({
        fallbackLocale: defaultLocale,
        initialLocale: null
    });

    return (req, res, next) => {
        try {
            const isDocument = DOCUMENT_REGEX.test(req.originalUrl);
            let isExcluded = false;

            for (const route of excludedRoutes) {
                if (req.path.startsWith(route)) {
                    isExcluded = true;
                }
            }

            if (!isDocument || isExcluded) {
                return next();
            }

            const locale = req.locale;

            if (locale !== null && locale !== currentLocale) {
                $locale.set(locale);
            }

            return next();
        } finally {
            unsubscribe();
        }
    }
}