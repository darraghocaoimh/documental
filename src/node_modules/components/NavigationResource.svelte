<script>
	import { stores } from '@sapper/app';
	import { locale } from 'services/i18n';
	import { menuOpen } from 'stores/menu';
    import { resourceArticles, resourceVersions } from 'stores/resource';
	import { quintOut } from 'svelte/easing';
    import { slide } from 'svelte/transition';

    export let category;
    export let heading;
    export let latestVersion = '';
    export let index = '';
    export let resource;
    export let singleton = false;

    const { page } = stores();
    const slideIn = { delay: 50, duration: 300, easing: quintOut };
    const slideOut = { delay: 100, duration: 300, easing: quintOut };

    $: currentResource = !!$page.params && !!$page.params.resource ? $page.params.resource : null;
    $: currentVersion = !!$page.params && !!$page.params.version ? $page.params.version : null;
    $: currentSlug = !!$page.params && !!$page.params.slug ? $page.params.slug : null;
</script>

{#if singleton}
    <a rel='prefetch' class:current={resource === currentResource} on:click={() => $menuOpen = false}
        class='heading' href={`/${$locale}/${category}/${resource}`}>
        {heading}
    </a>
{:else}
    {#if !!latestVersion}
        <a rel='prefetch'
            aria-haspopup='true' aria-expanded={resource === currentResource}
            class:current={resource === currentResource}
            class='heading'
            href={`/${$locale}/${category}/${resource}/${latestVersion}/${index}`}>
            {heading}
        </a>
        {#if resource === currentResource}
            <ol in:slide={slideIn} out:slide={slideOut}>
                {#each $resourceVersions as version}
                    <li>
                        <a rel='prefetch'
                            aria-haspopup='true' aria-expanded={version === currentVersion}
                            class:current={version === currentVersion}
                            class='version'
                            href={`/${$locale}/${category}/${resource}/${version}/${index}`}>{version}</a>
                        {#if version === currentVersion}
                            <ol>
                                {#each $resourceArticles as article}
                                    <li>
                                        <a rel='prefetch'
                                            class:current={article.slug === currentSlug} on:click={() => $menuOpen = false}
                                            class='article'
                                            href={`/${$locale}/${category}/${resource}/${version}/${article.slug}`}>
                                            {article.shortTitle ? article.shortTitle : article.title}
                                        </a>
                                    </li>
                                {/each}
                            </ol>
                        {/if}
                    </li>
                {/each}
            </ol>
        {/if}
    {:else}
        <a rel='prefetch'
            aria-haspopup='true' aria-expanded={resource === currentResource}
            class:current={resource === currentResource}
            class='heading'
            href={`/${$locale}/${category}/${resource}/${index}`}>
            {heading}
        </a>
        {#if resource === currentResource}
            <ol in:slide={slideIn} out:slide={slideOut}>
                {#each $resourceArticles as article}
                    <li>
                        <a rel='prefetch'
                            class:current={article.slug === currentSlug} on:click={() => $menuOpen = false}
                            class='article' 
                            href={`/${$locale}/${category}/${resource}/${article.slug}`}>
                            {article.shortTitle ? article.shortTitle : article.title}
                        </a>
                    </li>
                {/each}
            </ol>
        {/if}
    {/if}
{/if}

<style>
    a {
        display: block;
        padding: 0.5em;
        text-decoration: none;
    }

	ol {
        list-style: none;
		margin: 0 0 0 1rem;
		padding: 0;
    }

    ol ol {
		color: #555;
		text-transform: none;
    }
    
    .heading {
		margin-top: 0;
		padding: 0.5em;
    }

    .current {
        color: #4f858d;
        color: var(--secondary-color);
        font-weight: 700;
    }
</style>