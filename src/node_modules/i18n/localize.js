import { cookieName } from './settings';
import cookie from 'cookie';
import { cookieMaxAge } from 'i18n/settings';
import { locale, waitLocale } from 'svelte-i18n';

export default async function localize(page, session) {
    const currentLocale = page.params.locale;
    locale.set(currentLocale);
    session.locale = currentLocale;

    if (typeof document !== 'undefined' && !!document) {
        const currentCookies = cookie.parse(document.cookie);
        if (!currentCookies || !currentCookies[cookieName] || currentCookies[cookieName] !== currentLocale) {
            const localeCookie = cookie.serialize(cookieName, currentLocale, {
                maxAge: cookieMaxAge
            });
            document.cookie = localeCookie;
        }
    }

    return await waitLocale();
};