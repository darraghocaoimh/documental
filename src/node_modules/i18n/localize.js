import { cookieName, locales } from './settings';
import cookie from 'cookie';
import { cookieMaxAge, defaultLocale } from 'i18n/settings';
import { locale, waitLocale } from 'svelte-i18n';

export default async function localize(page, session) {
    let currentLocale = page.params.locale || session.locale;
    if (!locales.includes(currentLocale)) currentLocale = session.locale || defaultLocale;
    if (session.locale !== currentLocale) session.locale = currentLocale;
    locale.set(currentLocale);

    if (typeof document !== 'undefined' && !!document) {
        const currentCookies = cookie.parse(document.cookie);
        if (!currentCookies || !currentCookies[cookieName] || currentCookies[cookieName] !== currentLocale) {
            const localeCookie = cookie.serialize(cookieName, currentLocale, {
                maxAge: cookieMaxAge
            });
            document.cookie = localeCookie;
        }
    }

    return await waitLocale();
}