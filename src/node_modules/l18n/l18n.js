import { derived, writable } from 'svelte/store';

const defaultLocale = 'en';
const supportedLocales = ['en', 'ga'];

let currentLocale;

const localizer = (localizeableString) => {
    if (!localizeableString)
        return "";
    
    let localizedString = localizeableString;
    const segments = localizeableString.split('|');

    for (let i = 0; i < segments.length; i++) {
        const segment = segments[i].trim();

        if (segment.indexOf(`${currentLocale}:`) === 0) {
            localizedString = segment.substring((`${currentLocale}:`).length, localizedString.length);
            break;
        }
    }

    return localizedString.trim();
}

const locale = writable(defaultLocale);

const setLocale = locale.set;

locale.set = newLocale => {
    if (!supportedLocales.includes(newLocale)) {
        console.warn(`[documental] Locale "${newLocale}" not found.`);
        newLocale = defaultLocale;
    }
    
    return setLocale(newLocale);
}

locale.update = () => {
    setLocale(() => currentLocale);
};

locale.subscribe(newLocale => {
    currentLocale = newLocale
})

const localize = derived([locale], () => localizer);

export {
    locale,
    localize,
    localize as _L
};